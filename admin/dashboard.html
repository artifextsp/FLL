<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FLL - Admin Dashboard</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <nav class="nav">
        <div class="container nav-list">
            <a href="dashboard.html" class="nav-link active">Dashboard</a>
            <a href="eventos.html" class="nav-link">Eventos</a>
            <a href="equipos.html" class="nav-link">Equipos</a>
            <a href="jurados.html" class="nav-link">Jurados</a>
            <a href="rubricas.html" class="nav-link">R√∫bricas</a>
            <a href="#" id="btn-logout" class="nav-link" style="margin-left: auto;">Salir</a>
        </div>
    </nav>

    <div class="container">
        <h1 class="mb-lg">Panel de Administraci√≥n</h1>
        
        <div class="grid grid-3">
            <a href="eventos.html" class="card" style="text-decoration: none; color: inherit; transition: transform 0.2s;">
                <h3>üìÖ Eventos</h3>
                <p class="text-secondary mt-sm">Gestionar torneos y fechas</p>
            </a>
            <a href="equipos.html" class="card" style="text-decoration: none; color: inherit; transition: transform 0.2s;">
                <h3>ü§ñ Equipos</h3>
                <p class="text-secondary mt-sm">Gestionar participantes</p>
            </a>
            <a href="jurados.html" class="card" style="text-decoration: none; color: inherit; transition: transform 0.2s;">
                <h3>üë®‚Äç‚öñÔ∏è Jurados</h3>
                <p class="text-secondary mt-sm">Asignar jueces</p>
            </a>
        </div>
        
        <div class="card mt-lg" style="border: 2px solid var(--danger, #f44336);">
            <h3 style="color: var(--danger, #f44336); margin-bottom: 12px;">‚ö†Ô∏è Zona de Administraci√≥n</h3>
            <p class="text-secondary mb-md">Acciones administrativas avanzadas:</p>
            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <button id="btn-eliminar-calificaciones" class="btn" style="background: var(--danger, #f44336); color: white;">
                    üóëÔ∏è Eliminar Todas las Calificaciones
                </button>
                <a href="../equipo/resultados.html" class="btn btn-primary" style="text-decoration: none; display: inline-block;">
                    üìä Ver Resultados Generales
                </a>
            </div>
        </div>
    </div>

    <script type="module">
        // ============================================
        // VERIFICACI√ìN DE AUTENTICACI√ìN SIMPLIFICADA
        // ============================================
        
        import { requireRole, logout } from '../js/auth.js';
        import { supabase } from '../js/supabase.js';
        import { mostrarAlerta, confirmarAccion } from '../js/utils.js';
        
        // Verificar autenticaci√≥n y rol de forma s√≠ncrona y directa
        const user = requireRole('admin');
        
        if (user) {
            // Usuario autenticado correctamente como admin
            console.log('‚úÖ Dashboard admin - Usuario autenticado:', user.id);
            
            // Configurar bot√≥n de logout
            document.getElementById('btn-logout').addEventListener('click', (e) => {
                e.preventDefault();
                logout();
            });
            
            // Configurar bot√≥n para eliminar todas las calificaciones
            const btnEliminarCalificaciones = document.getElementById('btn-eliminar-calificaciones');
            if (btnEliminarCalificaciones) {
                btnEliminarCalificaciones.addEventListener('click', async () => {
                    const confirmar = confirmarAccion(
                        '‚ö†Ô∏è ADVERTENCIA: Esta acci√≥n eliminar√° TODAS las calificaciones de la base de datos.\n\n' +
                        'Esta acci√≥n NO se puede deshacer.\n\n' +
                        '¬øEst√°s seguro de que deseas continuar?'
                    );
                    
                    if (!confirmar) return;
                    
                    // Segunda confirmaci√≥n
                    const confirmar2 = confirmarAccion(
                        '‚ö†Ô∏è √öLTIMA CONFIRMACI√ìN\n\n' +
                        'Vas a eliminar TODAS las calificaciones permanentemente.\n\n' +
                        '¬øEst√°s completamente seguro?'
                    );
                    
                    if (!confirmar2) return;
                    
                    btnEliminarCalificaciones.disabled = true;
                    btnEliminarCalificaciones.textContent = 'Eliminando...';
                    
                    try {
                        // Eliminar todas las calificaciones usando deleteHardSupabase
                        const { error } = await supabase
                            .from('calificaciones')
                            .delete()
                            .neq('id', '00000000-0000-0000-0000-000000000000'); // Condici√≥n que siempre es true para eliminar todas
                        
                        if (error) throw error;
                        
                        mostrarAlerta('‚úÖ Todas las calificaciones han sido eliminadas correctamente', 'success', 5000);
                        
                    } catch (error) {
                        console.error('Error eliminando calificaciones:', error);
                        mostrarAlerta(`Error al eliminar calificaciones: ${error.message}`, 'error');
                    } finally {
                        btnEliminarCalificaciones.disabled = false;
                        btnEliminarCalificaciones.textContent = 'üóëÔ∏è Eliminar Todas las Calificaciones';
                    }
                });
            }
        }
        // Si no hay usuario o no tiene el rol correcto, requireRole ya redirigi√≥ al login
    </script>
</body>
</html>
