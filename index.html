<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FLL - Inicio de Sesi√≥n</title>
    <link rel="stylesheet" href="./css/styles.css">
</head>
<body>
    <div class="container" style="max-width: 400px; margin-top: 10vh;">
        <div class="card text-center">
            <h1 class="mb-lg" style="color: var(--primary-color);">FLL Calificaci√≥n</h1>
            <p class="mb-lg text-secondary">Sistema de gesti√≥n y calificaci√≥n de equipos</p>
            
            <div id="login-form">
                <!-- El login real se integrar√° con el sistema de Ludens -->
                <!-- Por ahora simulamos el login para desarrollo -->
                <div class="form-group text-left">
                    <label class="form-label">Usuario</label>
                    <input type="text" id="username" class="form-input" placeholder="Usuario">
                </div>
                
                <div class="form-group text-left">
                    <label class="form-label">Contrase√±a</label>
                    <input type="password" id="password" class="form-input" placeholder="Contrase√±a">
                </div>
                
                <button id="btn-login" class="btn btn-primary" style="width: 100%;">Iniciar Sesi√≥n</button>
                
                <div id="error-msg" class="alerta alerta-error mt-md hidden"></div>
                
                <div class="mt-md" style="text-align: center;">
                    <button id="btn-limpiar-sesion" class="btn btn-secondary" style="font-size: 0.85rem; padding: 6px 12px; background: transparent; border: 1px solid var(--border);">
                        üßπ Limpiar Sesi√≥n
                    </button>
                </div>
            </div>
            
            <p class="mt-lg text-secondary font-size-sm">
                Versi√≥n Beta 0.1.0
            </p>
        </div>
    </div>

    <script type="module">
        import { setUser, redirigirPorTipoUsuario } from './js/auth.js';
        
        // Simulaci√≥n de login para desarrollo (hasta integrar con Ludens real)
        document.getElementById('btn-login').addEventListener('click', async () => {
            const username = (document.getElementById('username').value || '').trim();
            
            if (!username) {
                mostrarError('Por favor ingresa un usuario');
                return;
            }
            
            // LIMPIAR SESI√ìN ANTERIOR primero (evita mezcla de credenciales)
            try {
                localStorage.removeItem('pcre_user');
                // Limpiar cualquier otro dato relacionado
                const keys = Object.keys(localStorage);
                keys.forEach(key => {
                    if (key.startsWith('pcre_')) {
                        localStorage.removeItem(key);
                    }
                });
            } catch (e) {
                console.warn('Error limpiando localStorage:', e);
            }
            
            // Simular usuario seg√∫n el input (para pruebas)
            let rol = 'jurado';
            const usernameLower = username.toLowerCase();
            
            // Detecci√≥n m√°s robusta de admin
            if (username === '94300774' || usernameLower.includes('admin') || usernameLower === 'admin') {
                rol = 'admin';
            } else if (usernameLower.includes('equipo') || usernameLower.includes('estudiante')) {
                rol = 'estudiante';
            }
            
            console.log('üîê Login:', { username, rol });
            
            // IMPORTANTE: id = usuario para que coincida con usuario_id en jurados (admin/equipo igual)
            const fakeUser = {
                id: username,
                username,
                tipo_usuario: rol,
                rol_activo: rol,
                nombre: username === '94300774' ? 'Hansel Pe√±a' : username,
                colegio_id: rol === 'admin' ? 1 : undefined
            };
            
            console.log('üë§ Usuario creado:', fakeUser);
            
            try {
                const guardado = setUser(fakeUser);
                if (!guardado) {
                    throw new Error('No se pudo guardar el usuario en localStorage');
                }
                
                // Verificar que se guard√≥ correctamente
                const verificado = getUser();
                if (!verificado || verificado.id !== username) {
                    throw new Error('El usuario no se guard√≥ correctamente');
                }
                
                console.log('‚úÖ Usuario guardado correctamente:', verificado);
                await redirigirPorTipoUsuario();
            } catch (e) {
                console.error('‚ùå Error en login:', e);
                mostrarError('Error al iniciar sesi√≥n: ' + (e.message || 'Error desconocido'));
            }
        });

        function mostrarError(msg) {
            const el = document.getElementById('error-msg');
            el.textContent = msg;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 3000);
        }
        
        // Bot√≥n para limpiar sesi√≥n manualmente
        document.getElementById('btn-limpiar-sesion').addEventListener('click', () => {
            try {
                localStorage.clear();
                mostrarError('Sesi√≥n limpiada. Puedes iniciar sesi√≥n de nuevo.');
                console.log('üßπ localStorage limpiado manualmente');
            } catch (e) {
                console.error('Error limpiando:', e);
                mostrarError('Error al limpiar sesi√≥n');
            }
        });
    </script>
</body>
</html>
