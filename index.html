<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FLL - Inicio de Sesi√≥n</title>
    <link rel="stylesheet" href="./css/styles.css">
</head>
<body>
    <div class="container" style="max-width: 400px; margin-top: 10vh;">
        <div class="card text-center">
            <h1 class="mb-lg" style="color: var(--primary-color);">FLL Calificaci√≥n</h1>
            <p class="mb-lg text-secondary">Sistema de gesti√≥n y calificaci√≥n de equipos</p>
            
            <div id="login-form">
                <!-- El login real se integrar√° con el sistema de Ludens -->
                <!-- Por ahora simulamos el login para desarrollo -->
                <div class="form-group text-left">
                    <label class="form-label">Usuario</label>
                    <input type="text" id="username" class="form-input" placeholder="Usuario">
                </div>
                
                <div class="form-group text-left">
                    <label class="form-label">Contrase√±a</label>
                    <input type="password" id="password" class="form-input" placeholder="Contrase√±a">
                </div>
                
                <button id="btn-login" class="btn btn-primary" style="width: 100%;">Iniciar Sesi√≥n</button>
                
                <div id="error-msg" class="alerta alerta-error mt-md hidden"></div>
                
                <div class="mt-md" style="text-align: center;">
                    <button id="btn-limpiar-sesion" class="btn btn-secondary" style="font-size: 0.85rem; padding: 6px 12px; background: transparent; border: 1px solid var(--border);">
                        üßπ Limpiar Sesi√≥n
                    </button>
                </div>
            </div>
            
            <p class="mt-lg text-secondary font-size-sm">
                Versi√≥n Beta 0.1.0
            </p>
        </div>
    </div>

    <script type="module">
        import { setUser, getUser, redirigirPorTipoUsuario } from './js/auth.js';
        
        // Simulaci√≥n de login para desarrollo (hasta integrar con Ludens real)
        document.getElementById('btn-login').addEventListener('click', async () => {
            const usernameInput = document.getElementById('username');
            const username = (usernameInput.value || '').trim();
            
            if (!username) {
                mostrarError('Por favor ingresa un usuario');
                usernameInput.focus();
                return;
            }
            
            // Validar longitud m√≠nima
            if (username.length < 3) {
                mostrarError('El usuario debe tener al menos 3 caracteres');
                usernameInput.focus();
                return;
            }
            
            // Deshabilitar bot√≥n para prevenir m√∫ltiples clicks
            const btnLogin = document.getElementById('btn-login');
            btnLogin.disabled = true;
            btnLogin.textContent = 'Iniciando sesi√≥n...';
            
            try {
                // Limpiar sesi√≥n anterior completamente (evita mezcla admin/jurado)
                console.log('üßπ Limpiando sesi√≥n anterior...');
                try {
                    localStorage.removeItem('pcre_user');
                    localStorage.removeItem('pcre_user_timestamp');
                    Object.keys(localStorage).forEach(k => { 
                        if (k.startsWith('pcre_')) localStorage.removeItem(k); 
                    });
                } catch (e) { 
                    console.warn('‚ö†Ô∏è Error al limpiar sesi√≥n anterior:', e);
                }
                // Esperar un momento para asegurar limpieza
                await new Promise(resolve => setTimeout(resolve, 50));
                
                // Roles fijos: admin solo 94300774 o "admin" exacto. Resto = jurado (o estudiante si "equipo")
                let rol = 'jurado';
                const u = username.toLowerCase();
                if (username === '94300774' || u === 'admin') {
                    rol = 'admin';
                    console.log('üîê Login: Detectado como ADMIN');
                } else if (u === 'equipo' || u === 'estudiante') {
                    rol = 'estudiante';
                    console.log('üîê Login: Detectado como ESTUDIANTE');
                } else {
                    console.log('üîê Login: Detectado como JURADO (username:', username, ')');
                }
                
                const fakeUser = {
                    id: username,
                    username: username,
                    tipo_usuario: rol,
                    rol_activo: rol,
                    nombre: username === '94300774' ? 'Hansel Pe√±a' : username,
                    colegio_id: rol === 'admin' ? 1 : undefined
                };
                
                console.log('üë§ Usuario creado:', fakeUser);
                
                // Guardar usuario con validaci√≥n
                if (!setUser(fakeUser)) {
                    throw new Error('No se pudo guardar la sesi√≥n. Intenta de nuevo.');
                }
                
                // Verificar que se guard√≥ correctamente (con retry)
                let v = getUser();
                let retries = 0;
                while ((!v || !v.id) && retries < 3) {
                    console.log(`‚è≥ Reintentando verificaci√≥n (${retries + 1}/3)...`);
                    await new Promise(resolve => setTimeout(resolve, 100));
                    v = getUser();
                    retries++;
                }
                
                if (!v || !v.id) {
                    throw new Error('Sesi√≥n no guardada correctamente. Intenta de nuevo.');
                }
                
                console.log('‚úÖ Usuario guardado y verificado. Redirigiendo...');
                
                // Determinar destino directamente (sin await para evitar problemas)
                const user = getUser();
                if (!user) {
                    throw new Error('Usuario no encontrado despu√©s de guardar');
                }
                
                const tipoActivo = user.rol_activo || user.tipo_usuario;
                console.log('üîç Tipo activo para redirecci√≥n:', tipoActivo);
                
                // Construir URL de destino directamente
                let destino = '';
                const base = window.location.pathname.toLowerCase().startsWith('/fll') ? '/FLL' : 
                            (window.location.hostname.includes('vercel.app') ? '/FLL' : '');
                const b = base ? base + '/' : '/';
                
                switch (tipoActivo.toLowerCase()) {
                    case 'estudiante':
                        destino = b + 'equipo/dashboard.html';
                        break;
                    case 'docente':
                    case 'jurado':
                        destino = b + 'jurado/dashboard.html';
                        break;
                    case 'admin':
                    case 'super_admin':
                        destino = b + 'admin/dashboard.html';
                        break;
                    default:
                        destino = base + '/index.html';
                }
                
                // Construir URL absoluta completa
                const urlCompleta = destino.startsWith('http') ? destino : 
                    window.location.origin + destino;
                
                console.log('üéØ URL completa construida:', urlCompleta);
                console.log('üöÄ REDIRIGIENDO AHORA...');
                
                // CR√çTICO: M√∫ltiples m√©todos de redirecci√≥n para asegurar que funcione
                // M√©todo 1: replace inmediato
                try {
                    window.location.replace(urlCompleta);
                } catch (e) {
                    console.error('Error con replace:', e);
                }
                
                // M√©todo 2: href como backup inmediato
                try {
                    window.location.href = urlCompleta;
                } catch (e) {
                    console.error('Error con href:', e);
                }
                
                // M√©todo 3: Si estamos en iframe, usar top.location
                try {
                    if (window.top !== window.self) {
                        window.top.location.href = urlCompleta;
                    }
                } catch (e) {
                    console.warn('No se puede acceder a top.location (probablemente CORS)');
                }
                
                // M√©todo 4: Fallback con timeout m√°s largo
                setTimeout(() => {
                    const currentUrl = window.location.href;
                    const expectedPath = urlCompleta.split('/').pop();
                    if (!currentUrl.includes(expectedPath)) {
                        console.error('‚ö†Ô∏è Redirecci√≥n fall√≥, forzando con location.assign...');
                        window.location.assign(urlCompleta);
                    }
                }, 100);
                
                // NO EJECUTAR M√ÅS C√ìDIGO DESPU√âS DE ESTO
                return;
                
            } catch (e) {
                console.error('‚ùå Error en login:', e);
                mostrarError(e.message || 'Error al iniciar sesi√≥n');
                // Rehabilitar bot√≥n
                btnLogin.disabled = false;
                btnLogin.textContent = 'Iniciar Sesi√≥n';
            }
        });

        function mostrarError(msg) {
            const el = document.getElementById('error-msg');
            el.textContent = msg;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 3000);
        }
        
        // Bot√≥n para limpiar sesi√≥n manualmente
        document.getElementById('btn-limpiar-sesion').addEventListener('click', () => {
            try {
                localStorage.clear();
                mostrarError('Sesi√≥n limpiada. Puedes iniciar sesi√≥n de nuevo.');
                console.log('üßπ localStorage limpiado manualmente');
            } catch (e) {
                console.error('Error limpiando:', e);
                mostrarError('Error al limpiar sesi√≥n');
            }
        });
    </script>
</body>
</html>
