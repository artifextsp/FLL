<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FLL - Inicio de Sesi√≥n</title>
    <link rel="stylesheet" href="./css/styles.css">
</head>
<body>
    <div class="container" style="max-width: 400px; margin-top: 10vh;">
        <div class="card text-center">
            <h1 class="mb-lg" style="color: var(--primary-color);">FLL Calificaci√≥n</h1>
            <p class="mb-lg text-secondary">Sistema de gesti√≥n y calificaci√≥n de equipos</p>
            
            <div id="login-form">
                <!-- El login real se integrar√° con el sistema de Ludens -->
                <!-- Por ahora simulamos el login para desarrollo -->
                <div class="form-group text-left">
                    <label class="form-label">Usuario</label>
                    <input type="text" id="username" class="form-input" placeholder="Usuario">
                </div>
                
                <div class="form-group text-left">
                    <label class="form-label">Contrase√±a</label>
                    <input type="password" id="password" class="form-input" placeholder="Contrase√±a">
                </div>
                
                <button id="btn-login" class="btn btn-primary" style="width: 100%;">Iniciar Sesi√≥n</button>
                
                <div id="error-msg" class="alerta alerta-error mt-md hidden"></div>
                
                <div class="mt-md" style="text-align: center;">
                    <button id="btn-limpiar-sesion" class="btn btn-secondary" style="font-size: 0.85rem; padding: 6px 12px; background: transparent; border: 1px solid var(--border);">
                        üßπ Limpiar Sesi√≥n
                    </button>
                </div>
            </div>
            
            <p class="mt-lg text-secondary font-size-sm">
                Versi√≥n Beta 0.1.0
            </p>
        </div>
    </div>

    <script type="module">
        import { setUser, getUser, redirigirPorTipoUsuario } from './js/auth.js';
        
        // Simulaci√≥n de login para desarrollo (hasta integrar con Ludens real)
        document.getElementById('btn-login').addEventListener('click', async () => {
            const username = (document.getElementById('username').value || '').trim();
            
            if (!username) {
                mostrarError('Por favor ingresa un usuario');
                return;
            }
            
            // Limpiar solo sesi√≥n anterior (evita mezcla admin/jurado)
            try {
                localStorage.removeItem('pcre_user');
                Object.keys(localStorage).forEach(k => { if (k.startsWith('pcre_')) localStorage.removeItem(k); });
            } catch (e) { /* ignore */ }
            
            // Roles fijos: admin solo 94300774 o "admin" exacto. Resto = jurado (o estudiante si "equipo")
            let rol = 'jurado';
            const u = username.toLowerCase();
            if (username === '94300774' || u === 'admin') {
                rol = 'admin';
                console.log('üîê Login: Detectado como ADMIN');
            } else if (u === 'equipo' || u === 'estudiante') {
                rol = 'estudiante';
                console.log('üîê Login: Detectado como ESTUDIANTE');
            } else {
                console.log('üîê Login: Detectado como JURADO (username:', username, ')');
            }
            
            const fakeUser = {
                id: username,
                username,
                tipo_usuario: rol,
                rol_activo: rol,
                nombre: username === '94300774' ? 'Hansel Pe√±a' : username,
                colegio_id: rol === 'admin' ? 1 : undefined
            };
            
            console.log('üë§ Usuario creado:', fakeUser);
            
            try {
                if (!setUser(fakeUser)) throw new Error('No se pudo guardar la sesi√≥n');
                const v = getUser();
                if (!v || !v.id) throw new Error('Sesi√≥n no guardada correctamente');
                console.log('‚úÖ Usuario guardado. Redirigiendo...');
                await redirigirPorTipoUsuario();
            } catch (e) {
                console.error('‚ùå Error en login:', e);
                mostrarError(e.message || 'Error al iniciar sesi√≥n');
            }
        });

        function mostrarError(msg) {
            const el = document.getElementById('error-msg');
            el.textContent = msg;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 3000);
        }
        
        // Bot√≥n para limpiar sesi√≥n manualmente
        document.getElementById('btn-limpiar-sesion').addEventListener('click', () => {
            try {
                localStorage.clear();
                mostrarError('Sesi√≥n limpiada. Puedes iniciar sesi√≥n de nuevo.');
                console.log('üßπ localStorage limpiado manualmente');
            } catch (e) {
                console.error('Error limpiando:', e);
                mostrarError('Error al limpiar sesi√≥n');
            }
        });
    </script>
</body>
</html>
